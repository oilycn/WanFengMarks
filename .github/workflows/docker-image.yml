name: Docker Image CI/CD # 工作流名称更名为 CI/CD

on:
  push:
    branches: [ "master" ] # 当 master 分支有 push 操作时触发
  pull_request:
    branches: [ "master" ] # 当向 master 分支发起 pull request 时触发

env:
  DOCKER_IMAGE_NAME: oilycn/wanfeng-marks # <-- 【重要】替换为你的 Docker Hub 用户名/仓库名
  # 例如：myuser/my-app

jobs:
  build_and_push: # Job 名称改为 build_and_push

    runs-on: ubuntu-latest # 在 Ubuntu 最新版本上运行
    permissions:
      contents: read
      packages: write # 如果也推送到 GitHub Packages，则需要此权限

    steps:
      - name: Checkout repository # 步骤1: 检出代码
        uses: actions/checkout@v4

      - name: Log in to Docker Hub # 步骤2: 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }} # 从 GitHub Secret 获取用户名
          password: ${{ secrets.DOCKER_PASSWORD }} # 从 GitHub Secret 获取密码

      - name: Set up Docker Buildx # 步骤3: 设置 Buildx (推荐用于更高效构建)
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata (tags, labels) for Docker # 步骤4: 提取 Docker 镜像的元数据和标签
        id: meta # 给这个步骤一个ID，以便后续引用其输出
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }} # 使用 env 中定义的镜像名
          tags: | # 定义镜像标签的策略
            type=schedule
            type=ref,event=branch # 例如：master -> myuser/my-app:master
            type=ref,event=pr
            type=sha,prefix=sha-,format=long # 例如：myuser/my-app:sha-abcdef1234567890
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }} # 只有在默认分支 push 时才打 latest 标签

      - name: Build and push Docker image # 步骤5: 构建并推送 Docker 镜像
        uses: docker/build-push-action@v5
        with:
          context: . # Dockerfile 的上下文路径 (这里是当前目录)
          file: Dockerfile # Dockerfile 的路径 (如果不是项目根目录下的 Dockerfile，需要指定)
          push: true # 启用推送
          tags: ${{ steps.meta.outputs.tags }} # 使用上一步生成的标签
          labels: ${{ steps.meta.outputs.labels }} # 使用上一步生成的标签
          cache-from: type=gha # 启用 GitHub Actions 缓存 (可选，提高构建速度)
          cache-to: type=gha,mode=max
